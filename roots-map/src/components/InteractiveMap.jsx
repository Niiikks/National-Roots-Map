import React, { useState, useEffect, useRef } from 'react';
import { MapPin, Search, Filter, X, Calendar, Heart, Share2, ZoomIn, ZoomOut } from 'lucide-react';

const InteractiveMap = () => {
  const mapRef = useRef(null);
  const mapInstanceRef = useRef(null);
  const markersRef = useRef([]);
  const initAttemptRef = useRef(0);
  
  const [selectedStory, setSelectedStory] = useState(null);
  const [showFilters, setShowFilters] = useState(false);
  const [searchQuery, setSearchQuery] = useState('');
  const [mapReady, setMapReady] = useState(false);
  const [activeFilters, setActiveFilters] = useState({
    generation: 'all',
    country: 'all',
    category: 'all'
  });

  const mockStories = [
    {
      id: 1,
      title: "·É©·Éî·Éõ·Éò ·Éë·Éî·Éë·Éò·Éò·É° ·É°·Éê·ÉÆ·Éö·Éò ·É°·Éï·Éê·Éú·Éî·Éó·É®·Éò",
      description: "·Éê·É• ·Éí·Éê·Éï·Éò·Éñ·Éê·É†·Éì·Éî ·Éì·Éê ·Éï·Éò·É°·É¨·Éê·Éï·Éö·Éî ·É•·Éê·É†·Éó·É£·Éö·Éò ·É¢·É†·Éê·Éì·Éò·É™·Éò·Éî·Éë·Éò. ·Éß·Éù·Éï·Éî·Éö ·Éñ·Éê·É§·ÉÆ·É£·Éö·É° ·Éï·Éë·É†·É£·Éú·Éì·Éî·Éë·Éù·Éì·Éò ·Éê·Éõ ·É°·Éê·ÉÆ·Éö·É®·Éò.",
      image: "https://images.unsplash.com/photo-1589308078059-be1415eab4c3?w=400&h=300&fit=crop",
      author: "·Éú·Éò·Éú·Éù ·Éí·Éî·Éö·Éê·É®·Éï·Éò·Éö·Éò",
      location: "·Éõ·Éî·É°·É¢·Éò·Éê, ·É°·Éï·Éê·Éú·Éî·Éó·Éò",
      lat: 43.0442,
      lng: 42.7289,
      country: "·É°·Éê·É•·Éê·É†·Éó·Éï·Éî·Éö·Éù",
      generation: "1990s",
      category: "·Éù·ÉØ·Éê·ÉÆ·Éò",
      date: "1985-2000",
      likes: 124
    },
    {
      id: 2,
      title: "·Éì·Éò·Éê·É°·Éû·Éù·É†·Éò·É° ·É™·ÉÆ·Éù·Éï·É†·Éî·Éë·Éê ·Éö·Éù·Éú·Éì·Éù·Éú·É®·Éò",
      description: "30 ·É¨·Éî·Éö·Éò·Éê ·Éï·É™·ÉÆ·Éù·Éï·É†·Éù·Éë ·Éö·Éù·Éú·Éì·Éù·Éú·É®·Éò, ·Éõ·Éê·Éí·É†·Éê·Éõ ·É©·Éî·Éõ·Éò ·Éí·É£·Éö·Éò ·Éó·Éë·Éò·Éö·Éò·É°·É®·Éò·Éê. ·Éß·Éù·Éï·Éî·Éö·Éì·É¶·Éî ·Éï·Éê·Éõ·Éñ·Éê·Éì·Éî·Éë ·É•·Éê·É†·Éó·É£·Éö ·Éô·Éî·É†·É´·Éî·Éë·É°.",
      image: "https://images.unsplash.com/photo-1513635269975-59663e0ac1ad?w=400&h=300&fit=crop",
      author: "·Éí·Éò·Éù·É†·Éí·Éò ·Éõ·Éê·Éõ·É£·Éö·Éê·É®·Éï·Éò·Éö·Éò",
      location: "·Éö·Éù·Éú·Éì·Éù·Éú·Éò",
      lat: 51.5074,
      lng: -0.1278,
      country: "·Éì·Éò·Éì·Éò ·Éë·É†·Éò·É¢·Éê·Éú·Éî·Éó·Éò",
      generation: "1980s",
      category: "·Éì·Éò·Éê·É°·Éû·Éù·É†·Éê",
      date: "1993-·Éì·É¶·Éî·Éõ·Éì·Éî",
      likes: 89
    },
    {
      id: 3,
      title: "·Éë·Éê·Éó·É£·Éõ·Éò·É° ·É´·Éï·Éî·Éö·Éò ·É•·Éê·Éö·Éê·É•·Éò",
      description: "·É©·Éî·Éõ·Éò ·Éë·Éê·Éë·É£·Éê ·Éê·É• ·É∞·É•·Éù·Éú·Éì·Éê ·Éû·Éê·É¢·Éê·É†·Éê ·Éì·É£·É•·Éê·Éú·Éò. ·Éõ·Éê·ÉÆ·É°·Éù·Éï·É° ·Éñ·É¶·Éï·Éò·É° ·É°·É£·Éú·Éò ·Éì·Éê ·É™·Éò·É¢·É†·É£·É°·Éò·É° ·ÉÆ·Éî·Éî·Éë·Éò.",
      image: "https://images.unsplash.com/photo-1590050225473-60b89f82d5ab?w=400&h=300&fit=crop",
      author: "·Éê·Éú·Éê ·ÉÆ·É£·É™·Éò·É®·Éï·Éò·Éö·Éò",
      location: "·Éë·Éê·Éó·É£·Éõ·Éò, ·Éê·É≠·Éê·É†·Éê",
      lat: 41.6168,
      lng: 41.6367,
      country: "·É°·Éê·É•·Éê·É†·Éó·Éï·Éî·Éö·Éù",
      generation: "2000s",
      category: "·Éò·É°·É¢·Éù·É†·Éò·Éê",
      date: "1960-1990",
      likes: 156
    },
    {
      id: 4,
      title: "·Éõ·É™·ÉÆ·Éî·Éó·Éê - ·É©·Éî·Éõ·Éò ·É°·É£·Éö·Éò·Éî·É†·Éò ·É°·Éê·ÉÆ·Éö·Éò",
      description: "·É°·Éï·Éî·É¢·Éò·É™·ÉÆ·Éù·Éï·Éî·Éö·Éò ·Éß·Éù·Éï·Éî·Éö·Éó·Éï·Éò·É° ·Éò·Éß·Éù ·É©·Éî·Éõ·Éò ·Éù·ÉØ·Éê·ÉÆ·Éò·É° ·É°·Éê·Éô·É£·É†·Éó·ÉÆ·Éî·Éï·Éî·Éö·Éò. ·Éê·É• ·Éì·Éê·Éï·Éë·É†·É£·Éú·Éì·Éò ·Éî·Éõ·Éò·Éí·É†·Éê·É™·Éò·Éò·É° ·É®·Éî·Éõ·Éì·Éî·Éí.",
      image: "https://images.unsplash.com/photo-1590229991827-63872fa23f24?w=400&h=300&fit=crop",
      author: "·Éì·Éê·Éï·Éò·Éó ·Éß·Éò·É§·Éò·Éê·Éú·Éò",
      location: "·Éõ·É™·ÉÆ·Éî·Éó·Éê",
      lat: 41.8431,
      lng: 44.7209,
      country: "·É°·Éê·É•·Éê·É†·Éó·Éï·Éî·Éö·Éù",
      generation: "1970s",
      category: "·É†·Éî·Éö·Éò·Éí·Éò·Éê",
      date: "1950-2024",
      likes: 203
    },
    {
      id: 5,
      title: "·É•·Éê·É†·Éó·É£·Éö·Éò ·Éî·Éú·Éò·É° ·É®·Éî·Éú·Éê·É†·É©·É£·Éú·Éî·Éë·Éê ·Éì·É£·Éë·Éö·Éò·Éú·É®·Éò",
      description: "·É©·Éî·Éõ·É° ·É®·Éï·Éò·Éö·Éî·Éë·É° ·Éï·Éê·É°·É¨·Éê·Éï·Éö·Éò ·É•·Éê·É†·Éó·É£·Éö·É°. ·Éß·Éù·Éï·Éî·Éö ·Éô·Éï·Éò·É†·Éê·É° ·Éï·Éô·Éò·Éó·ÉÆ·É£·Éö·Éù·Éë·Éó ·É•·Éê·É†·Éó·É£·Éö ·Éñ·É¶·Éê·Éû·É†·Éî·Éë·É°.",
      image: "https://images.unsplash.com/photo-1549918864-48ac978761a4?w=400&h=300&fit=crop",
      author: "·Éî·Éô·Éê ·Éõ·Éî·Éí·É†·Éî·Éö·Éò·É®·Éï·Éò·Éö·Éò",
      location: "·Éì·É£·Éë·Éö·Éò·Éú·Éò",
      lat: 53.3498,
      lng: -6.2603,
      country: "·Éò·É†·Éö·Éê·Éú·Éì·Éò·Éê",
      generation: "2010s",
      category: "·Éî·Éú·Éê",
      date: "2015-·Éì·É¶·Éî·Éõ·Éì·Éî",
      likes: 92
    },
    {
      id: 6,
      title: "·É•·É£·Éó·Éê·Éò·É°·Éò·É° ·Éë·Éê·Éñ·Éê·É†·Éò",
      description: "·Éß·Éï·Éî·Éö·Éê·Éñ·Éî ·Éì·Éò·Éö·Éò·Éó ·Éë·Éê·Éë·É£·Éê·É°·Éó·Éê·Éú ·Éï·Éì·Éò·Éù·Éì·Éò ·Éë·Éê·Éñ·Éê·É†·É®·Éò. ·Éê·É• ·Éï·É°·É¨·Éê·Éï·Éö·Éù·Éë·Éì·Éò ·É•·Éê·É†·Éó·É£·Éö ·Éî·Éú·Éê·É° ·Éì·Éê ·É¢·É†·Éê·Éì·Éò·É™·Éò·Éî·Éë·É°.",
      image: "https://images.unsplash.com/photo-1555396273-367ea4eb4db5?w=400&h=300&fit=crop",
      author: "·Éö·Éê·É®·Éê ·Éô·Éï·Éê·É†·Éê·É™·ÉÆ·Éî·Éö·Éò·Éê",
      location: "·É•·É£·Éó·Éê·Éò·É°·Éò, ·Éò·Éõ·Éî·É†·Éî·Éó·Éò",
      lat: 42.2679,
      lng: 42.6988,
      country: "·É°·Éê·É•·Éê·É†·Éó·Éï·Éî·Éö·Éù",
      generation: "2000s",
      category: "·É¢·É†·Éê·Éì·Éò·É™·Éò·Éî·Éë·Éò",
      date: "2005-2020",
      likes: 78
    }
  ];

  const filterOptions = {
    generation: [
      { value: 'all', label: '·Éß·Éï·Éî·Éö·Éê ·Éó·Éê·Éù·Éë·Éê' },
      { value: '1970s', label: '1970-·Éò·Éê·Éú·Éò' },
      { value: '1980s', label: '1980-·Éò·Éê·Éú·Éò' },
      { value: '1990s', label: '1990-·Éò·Éê·Éú·Éò' },
      { value: '2000s', label: '2000-·Éò·Éê·Éú·Éò' },
      { value: '2010s', label: '2010-·Éò·Éê·Éú·Éò' }
    ],
    country: [
      { value: 'all', label: '·Éß·Éï·Éî·Éö·Éê ·É•·Éï·Éî·Éß·Éê·Éú·Éê' },
      { value: '·É°·Éê·É•·Éê·É†·Éó·Éï·Éî·Éö·Éù', label: 'üá¨üá™ ·É°·Éê·É•·Éê·É†·Éó·Éï·Éî·Éö·Éù' },
      { value: '·Éì·Éò·Éì·Éò ·Éë·É†·Éò·É¢·Éê·Éú·Éî·Éó·Éò', label: 'üá¨üáß ·Éì·Éò·Éì·Éò ·Éë·É†·Éò·É¢·Éê·Éú·Éî·Éó·Éò' },
      { value: '·Éò·É†·Éö·Éê·Éú·Éì·Éò·Éê', label: 'üáÆüá™ ·Éò·É†·Éö·Éê·Éú·Éì·Éò·Éê' }
    ],
    category: [
      { value: 'all', label: '·Éß·Éï·Éî·Éö·Éê ·Éô·Éê·É¢·Éî·Éí·Éù·É†·Éò·Éê' },
      { value: '·Éù·ÉØ·Éê·ÉÆ·Éò', label: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ ·Éù·ÉØ·Éê·ÉÆ·Éò' },
      { value: '·Éì·Éò·Éê·É°·Éû·Éù·É†·Éê', label: 'üåç ·Éì·Éò·Éê·É°·Éû·Éù·É†·Éê' },
      { value: '·Éò·É°·É¢·Éù·É†·Éò·Éê', label: 'üìö ·Éò·É°·É¢·Éù·É†·Éò·Éê' },
      { value: '·É†·Éî·Éö·Éò·Éí·Éò·Éê', label: '‚õ™ ·É†·Éî·Éö·Éò·Éí·Éò·Éê' },
      { value: '·Éî·Éú·Éê', label: 'üó£Ô∏è ·Éî·Éú·Éê' },
      { value: '·É¢·É†·Éê·Éì·Éò·É™·Éò·Éî·Éë·Éò', label: 'üé≠ ·É¢·É†·Éê·Éì·Éò·É™·Éò·Éî·Éë·Éò' }
    ]
  };

  const filteredStories = mockStories.filter(story => {
    const matchesGeneration = activeFilters.generation === 'all' || story.generation === activeFilters.generation;
    const matchesCountry = activeFilters.country === 'all' || story.country === activeFilters.country;
    const matchesCategory = activeFilters.category === 'all' || story.category === activeFilters.category;
    const matchesSearch = searchQuery === '' || 
      story.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
      story.description.toLowerCase().includes(searchQuery.toLowerCase()) ||
      story.location.toLowerCase().includes(searchQuery.toLowerCase());
    
    return matchesGeneration && matchesCountry && matchesCategory && matchesSearch;
  });

  // Initialize map with retry logic
  useEffect(() => {
    const initMap = () => {
      if (!mapRef.current || mapInstanceRef.current) return;
      
      const L = window.L;
      if (!L) {
        if (initAttemptRef.current < 20) {
          initAttemptRef.current++;
          setTimeout(initMap, 500);
        }
        return;
      }

      try {
        const map = L.map(mapRef.current, {
          zoomControl: false,
          scrollWheelZoom: true,
          dragging: true,
          touchZoom: true
        }).setView([42.3154, 43.3569], 6);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap',
          maxZoom: 19
        }).addTo(map);

        mapInstanceRef.current = map;
        setMapReady(true);

        setTimeout(() => {
          map.invalidateSize();
        }, 200);
      } catch (error) {
        console.error('Map init error:', error);
      }
    };

    const timer = setTimeout(initMap, 100);

    return () => {
      clearTimeout(timer);
      if (mapInstanceRef.current) {
        mapInstanceRef.current.remove();
        mapInstanceRef.current = null;
      }
    };
  }, []);

  // Update markers
  useEffect(() => {
    if (!mapInstanceRef.current || !mapReady) return;

    const L = window.L;
    if (!L) return;

    const map = mapInstanceRef.current;

    markersRef.current.forEach(marker => {
      try {
        marker.remove();
      } catch (e) {
        console.log('Marker removal error');
      }
    });
    markersRef.current = [];

    const customIcon = (color) => L.divIcon({
      className: 'custom-marker',
      html: `
        <div style="
          background: linear-gradient(135deg, ${color}, ${color}dd);
          width: 40px;
          height: 40px;
          border-radius: 50% 50% 50% 0;
          border: 3px solid white;
          box-shadow: 0 4px 12px rgba(0,0,0,0.3);
          transform: rotate(-45deg);
          display: flex;
          align-items: center;
          justify-content: center;
        ">
          <div style="transform: rotate(45deg); font-size: 18px;">üìç</div>
        </div>
      `,
      iconSize: [40, 40],
      iconAnchor: [20, 40],
      popupAnchor: [0, -40]
    });

    filteredStories.forEach(story => {
      try {
        const color = story.country === '·É°·Éê·É•·Éê·É†·Éó·Éï·Éî·Éö·Éù' ? '#8B0000' : '#DAA520';
        const marker = L.marker([story.lat, story.lng], {
          icon: customIcon(color)
        })
          .addTo(map)
          .on('click', () => {
            setSelectedStory(story);
            map.flyTo([story.lat, story.lng], 10, {
              duration: 1.5
            });
          });

        markersRef.current.push(marker);
      } catch (e) {
        console.log('Marker creation error:', e);
      }
    });

    if (filteredStories.length > 0) {
      try {
        const bounds = L.latLngBounds(filteredStories.map(s => [s.lat, s.lng]));
        map.fitBounds(bounds, { padding: [50, 50], maxZoom: 12 });
      } catch (e) {
        console.log('Bounds error');
      }
    }
  }, [filteredStories, mapReady]);

  const handleFilterChange = (filterType, value) => {
    setActiveFilters(prev => ({
      ...prev,
      [filterType]: value
    }));
  };

  const resetFilters = () => {
    setActiveFilters({
      generation: 'all',
      country: 'all',
      category: 'all'
    });
    setSearchQuery('');
  };

  const zoomIn = () => {
    if (mapInstanceRef.current) {
      mapInstanceRef.current.zoomIn();
    }
  };

  const zoomOut = () => {
    if (mapInstanceRef.current) {
      mapInstanceRef.current.zoomOut();
    }
  };

  const activeFilterCount = Object.values(activeFilters).filter(v => v !== 'all').length;

  return (
    <>
      <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossOrigin="" />
      <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossOrigin=""></script>

      <div className="h-screen flex flex-col bg-slate-50">
        <header className="bg-white shadow-md z-20 relative">
          <div className="px-6 py-4">
            <div className="flex items-center justify-between mb-4">
              <div className="flex items-center space-x-3">
                <div className="w-10 h-10 bg-gradient-to-br from-red-600 to-red-800 rounded-lg flex items-center justify-center text-white font-bold text-xl">
                  ·Éî
                </div>
                <div>
                  <h1 className="text-xl font-bold text-slate-800">·É§·Éî·É°·Éï·Éî·Éë·Éò·É° ·É†·É£·Éô·Éê</h1>
                  <p className="text-xs text-slate-600">{filteredStories.length} ·Éò·É°·É¢·Éù·É†·Éò·Éê</p>
                </div>
              </div>
              <button className="px-4 py-2 bg-gradient-to-r from-red-600 to-red-700 text-white rounded-lg hover:shadow-lg transition-all text-sm font-semibold">
                + ·Éì·Éê·Éê·Éõ·Éê·É¢·Éî ·É®·Éî·Éú·Éò ·Éò·É°·É¢·Éù·É†·Éò·Éê
              </button>
            </div>

            <div className="flex gap-3">
              <div className="flex-1 relative">
                <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 w-5 h-5" />
                <input
                  type="text"
                  placeholder="·É´·Éò·Éî·Éë·Éê ·Éö·Éù·Éô·Éê·É™·Éò·Éò·É°, ·É°·Éê·Éó·Éê·É£·É†·Éò·É° ·Éê·Éú ·Éê·É¶·É¨·Éî·É†·Éò·É° ·Éõ·Éò·ÉÆ·Éî·Éì·Éï·Éò·Éó..."
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                  className="w-full pl-10 pr-4 py-3 border-2 border-slate-200 rounded-lg focus:border-red-500 focus:outline-none transition-colors"
                />
              </div>
              <button
                onClick={() => setShowFilters(!showFilters)}
                className={`px-6 py-3 rounded-lg font-semibold transition-all flex items-center space-x-2 ${
                  showFilters ? 'bg-red-600 text-white' : 'bg-white border-2 border-slate-200 text-slate-700 hover:border-red-500'
                }`}
              >
                <Filter className="w-5 h-5" />
                <span>·É§·Éò·Éö·É¢·É†·Éî·Éë·Éò</span>
                {activeFilterCount > 0 && (
                  <span className="bg-white text-red-600 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold">
                    {activeFilterCount}
                  </span>
                )}
              </button>
            </div>

            {showFilters && (
              <div className="mt-4 p-4 bg-slate-50 rounded-lg border-2 border-slate-200">
                <div className="grid md:grid-cols-3 gap-4 mb-4">
                  <div>
                    <label className="block text-sm font-semibold text-slate-700 mb-2">·Éó·Éê·Éù·Éë·Éê</label>
                    <select
                      value={activeFilters.generation}
                      onChange={(e) => handleFilterChange('generation', e.target.value)}
                      className="w-full p-2 border-2 border-slate-200 rounded-lg focus:border-red-500 focus:outline-none"
                    >
                      {filterOptions.generation.map(opt => (
                        <option key={opt.value} value={opt.value}>{opt.label}</option>
                      ))}
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-semibold text-slate-700 mb-2">·É•·Éï·Éî·Éß·Éê·Éú·Éê</label>
                    <select
                      value={activeFilters.country}
                      onChange={(e) => handleFilterChange('country', e.target.value)}
                      className="w-full p-2 border-2 border-slate-200 rounded-lg focus:border-red-500 focus:outline-none"
                    >
                      {filterOptions.country.map(opt => (
                        <option key={opt.value} value={opt.value}>{opt.label}</option>
                      ))}
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-semibold text-slate-700 mb-2">·Éô·Éê·É¢·Éî·Éí·Éù·É†·Éò·Éê</label>
                    <select
                      value={activeFilters.category}
                      onChange={(e) => handleFilterChange('category', e.target.value)}
                      className="w-full p-2 border-2 border-slate-200 rounded-lg focus:border-red-500 focus:outline-none"
                    >
                      {filterOptions.category.map(opt => (
                        <option key={opt.value} value={opt.value}>{opt.label}</option>
                      ))}
                    </select>
                  </div>
                </div>
                <button
                  onClick={resetFilters}
                  className="text-red-600 font-semibold text-sm hover:text-red-700 transition-colors"
                >
                  ·É§·Éò·Éö·É¢·É†·Éî·Éë·Éò·É° ·Éí·Éê·É°·É£·É§·Éó·Éê·Éï·Éî·Éë·Éê
                </button>
              </div>
            )}
          </div>
        </header>

        <div className="flex-1 relative">
          {!mapReady && (
            <div className="absolute inset-0 flex items-center justify-center bg-slate-100 z-20">
              <div className="text-center">
                <div className="w-16 h-16 border-4 border-red-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                <p className="text-slate-700 font-semibold">·É†·É£·Éô·Éê ·Éò·É¢·Éï·Éò·É†·Éó·Éî·Éë·Éê...</p>
                <p className="text-slate-500 text-sm mt-2">·Éó·É£ ·É†·É£·Éô·Éê ·Éê·É† ·É©·Éê·Éú·É°, ·Éí·Éê·Éú·Éê·Éê·ÉÆ·Éö·Éî·Éó ·Éí·Éï·Éî·É†·Éì·Éò</p>
              </div>
            </div>
          )}

          <div ref={mapRef} className="w-full h-full bg-slate-200" />

          {mapReady && (
            <>
              <div className="absolute right-6 top-6 bg-white rounded-lg shadow-lg overflow-hidden z-10">
                <button
                  onClick={zoomIn}
                  className="block p-3 hover:bg-slate-50 transition-colors border-b border-slate-200"
                  aria-label="Zoom in"
                >
                  <ZoomIn className="w-5 h-5 text-slate-700" />
                </button>
                <button
                  onClick={zoomOut}
                  className="block p-3 hover:bg-slate-50 transition-colors"
                  aria-label="Zoom out"
                >
                  <ZoomOut className="w-5 h-5 text-slate-700" />
                </button>
              </div>

              {selectedStory && (
                <div className="absolute bottom-6 left-6 right-6 md:left-auto md:w-96 bg-white rounded-2xl shadow-2xl overflow-hidden z-10 animate-slideUp">
                  <button
                    onClick={() => setSelectedStory(null)}
                    className="absolute top-4 right-4 w-8 h-8 bg-white rounded-full flex items-center justify-center shadow-lg hover:bg-slate-100 transition-colors z-10"
                    aria-label="Close"
                  >
                    <X className="w-5 h-5 text-slate-700" />
                  </button>

                  <img
                    src={selectedStory.image}
                    alt={selectedStory.title}
                    className="w-full h-48 object-cover"
                  />

                  <div className="p-6">
                    <h3 className="text-2xl font-bold text-slate-900 mb-3 pr-8">{selectedStory.title}</h3>

                    <div className="flex items-center space-x-4 mb-4 text-sm text-slate-600">
                      <div className="flex items-center space-x-1">
                        <MapPin className="w-4 h-4" />
                        <span>{selectedStory.location}</span>
                      </div>
                      <div className="flex items-center space-x-1">
                        <Calendar className="w-4 h-4" />
                        <span>{selectedStory.date}</span>
                      </div>
                    </div>

                    <p className="text-slate-700 mb-4 leading-relaxed">{selectedStory.description}</p>

                    <div className="flex items-center justify-between pt-4 border-t border-slate-200">
                      <div className="flex items-center space-x-2">
                        <div className="w-10 h-10 bg-gradient-to-br from-red-600 to-red-800 rounded-full flex items-center justify-center text-white font-bold">
                          {selectedStory.author.charAt(0)}
                        </div>
                        <div>
                          <div className="font-semibold text-sm text-slate-900">{selectedStory.author}</div>
                          <div className="text-xs text-slate-600">{selectedStory.country}</div>
                        </div>
                      </div>

                      <div className="flex items-center space-x-3">
                        <button className="flex items-center space-x-1 text-red-600 hover:text-red-700 transition-colors">
                          <Heart className="w-5 h-5" />
                          <span className="text-sm font-semibold">{selectedStory.likes}</span>
                        </button>
                        <button className="text-slate-600 hover:text-slate-700 transition-colors">
                          <Share2 className="w-5 h-5" />
                        </button>
                      </div>
                    </div>

                    <div className="mt-4 flex flex-wrap gap-2">
                      <span className="px-3 py-1 bg-red-100 text-red-700 rounded-full text-xs font-semibold">
                        {selectedStory.category}
                      </span>
                      <span className="px-3 py-1 bg-amber-100 text-amber-700 rounded-full text-xs font-semibold">
                        {selectedStory.generation}
                      </span>
                    </div>
                  </div>
                </div>
              )}

              {filteredStories.length === 0 && (
                <div className="absolute inset-0 flex items-center justify-center z-10 pointer-events-none">
                  <div className="bg-white rounded-2xl shadow-xl p-8 text-center max-w-md pointer-events-auto">
                    <div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                      <Search className="w-8 h-8 text-slate-400" />
                    </div>
                    <h3 className="text-xl font-bold text-slate-900 mb-2">·Éò·É°·É¢·Éù·É†·Éò·Éî·Éë·Éò ·Éï·Éî·É† ·Éõ·Éù·Éò·É´·Éî·Éë·Éú·Éê</h3>
                    <p className="text-slate-600 mb-4">·É®·Éî·É™·Éï·Éê·Éö·Éî·Éó ·É°·Éê·É´·Éò·Éî·Éë·Éù ·Éô·É†·Éò·É¢·Éî·É†·Éò·É£·Éõ·Éî·Éë·Éò ·Éê·Éú ·É§·Éò·Éö·É¢·É†·Éî·Éë·Éò</p>
                    <button
                      onClick={resetFilters}
                      className="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-semibold"
                    >
                      ·É§·Éò·Éö·É¢·É†·Éî·Éë·Éò·É° ·Éí·Éê·É°·É£·É§·Éó·Éê·Éï·Éî·Éë·Éê
                    </button>
                  </div>
                </div>
              )}
            </>
          )}
        </div>

        <style>{`
          @keyframes slideUp {
            from {
              opacity: 0;
              transform: translateY(20px);
            }
            to {
              opacity: 1;
              transform: translateY(0);
            }
          }
          .animate-slideUp {
            animation: slideUp 0.3s ease-out;
          }
          .leaflet-container {
            font-family: inherit;
            height: 100%;
            width: 100%;
            background: #e2e8f0;
          }
          .custom-marker {
            background: transparent !important;
            border: none !important;
          }
          .leaflet-popup-content-wrapper {
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
          }
          @keyframes spin {
            to { transform: rotate(360deg); }
          }
          .animate-spin {
            animation: spin 1s linear infinite;
          }
        `}</style>
      </div>
    </>
  );
};

export default InteractiveMap;